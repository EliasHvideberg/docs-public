"use strict";(self.webpackChunksaga_docs=self.webpackChunksaga_docs||[]).push([[617],{3905:function(e,n,r){r.d(n,{Zo:function(){return p},kt:function(){return m}});var t=r(7294);function a(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function i(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function l(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?i(Object(r),!0).forEach((function(n){a(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function o(e,n){if(null==e)return{};var r,t,a=function(e,n){if(null==e)return{};var r,t,a={},i=Object.keys(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||(a[r]=e[r]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=t.createContext({}),d=function(e){var n=t.useContext(s),r=n;return e&&(r="function"==typeof e?e(n):l(l({},n),e)),r},p=function(e){var n=d(e.components);return t.createElement(s.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},g=t.forwardRef((function(e,n){var r=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),g=d(r),m=a,k=g["".concat(s,".").concat(m)]||g[m]||u[m]||i;return r?t.createElement(k,l(l({ref:n},p),{},{components:r})):t.createElement(k,l({ref:n},p))}));function m(e,n){var r=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=r.length,l=new Array(i);l[0]=g;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o.mdxType="string"==typeof e?e:a,l[1]=o;for(var d=2;d<i;d++)l[d]=r[d];return t.createElement.apply(null,l)}return t.createElement.apply(null,r)}g.displayName="MDXCreateElement"},4590:function(e,n,r){r.r(n),r.d(n,{assets:function(){return p},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return o},metadata:function(){return d},toc:function(){return u}});var t=r(7462),a=r(3366),i=(r(7294),r(3905)),l=["components"],o={},s="Nyttig SQL-kunnskap",d={unversionedId:"bigquery/nyttig-sql-kunnskap",id:"bigquery/nyttig-sql-kunnskap",title:"Nyttig SQL-kunnskap",description:"Denne siden samler nyttig informasjon og queries som kan v\xe6re kjekke \xe5 vite om n\xe5r man gj\xf8r analyser med BigQuery.",source:"@site/docs/03-bigquery/nyttig-sql-kunnskap.md",sourceDirName:"03-bigquery",slug:"/bigquery/nyttig-sql-kunnskap",permalink:"/docs-public/bigquery/nyttig-sql-kunnskap",editUrl:"https://github.com/svvsaga/docs-public/edit/main/docs/03-bigquery/nyttig-sql-kunnskap.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Bruk av BigQuery",permalink:"/docs-public/bigquery/bruk-av-bigquery"},next:{title:"Eksempler",permalink:"/docs-public/eksempler/"}},p={},u=[{value:"Tablesample",id:"tablesample",level:2},{value:"Partisjonering",id:"partisjonering",level:2},{value:"Gruppering og aggregering",id:"gruppering-og-aggregering",level:2},{value:"Repeterende rader",id:"repeterende-rader",level:2},{value:"Testdata for utforming av sp\xf8rringer",id:"testdata-for-utforming-av-sp\xf8rringer",level:2},{value:"Deduplisering",id:"deduplisering",level:2}],g={toc:u};function m(e){var n=e.components,r=(0,a.Z)(e,l);return(0,i.kt)("wrapper",(0,t.Z)({},g,r,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"nyttig-sql-kunnskap"},"Nyttig SQL-kunnskap"),(0,i.kt)("p",null,"Denne siden samler nyttig informasjon og queries som kan v\xe6re kjekke \xe5 vite om n\xe5r man gj\xf8r analyser med BigQuery."),(0,i.kt)("h2",{id:"tablesample"},"Tablesample"),(0,i.kt)("p",null,"Noen ganger \xf8nsker man \xe5 f\xe5 et overblikk over innholdet i en tabell. Kanskje inneholder tabellen veldig store mengder data som gj\xf8r det un\xf8dvendig dyrt \xe5 eksperimentere med queries mot den, eller man trenger bare \xe5 gj\xf8re seg opp en formening om sp\xf8rringen kommer til \xe5 fungere eller ikke i forkant av at man kj\xf8rer den mot hele datasettet."),(0,i.kt)("p",null,"I disse tilfellene kan ",(0,i.kt)("inlineCode",{parentName:"p"},"TABLESAMPLE")," brukes for \xe5 kj\xf8re sp\xf8rringen mot et randomisert utvalg samples av de underliggende radene i tabellen. Under vises en eksempelsp\xf8rring der 1% av innholdet i tabellen som inneholder situasjoner fra Vegloggen/HBT. Denne sp\xf8rringen henter i overkant av 100MB isteden for de ~17GB tabellen inneholder per dags dato."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n  *\nFROM\n  `saga-veglogg-prod-wznf.internal.situations_v2`\nTABLESAMPLE SYSTEM\n  (1 PERCENT)\n")),(0,i.kt)("h2",{id:"partisjonering"},"Partisjonering"),(0,i.kt)("p",null,"For tabeller med store mengder data kan partisjonering benyttes for \xe5 samlokalisere data basert p\xe5 et utvalg kolonner. Dette kan b\xe5de ha en positivt effekt p\xe5 pris og effektiviteten p\xe5 sp\xf8rringene da bare trenger \xe5 operere p\xe5 deler av dataene."),(0,i.kt)("p",null,"Eksempelet under viser hvordan den partisjonerte tabellen ",(0,i.kt)("inlineCode",{parentName:"p"},"internal.timetrafikk")," bare trenger \xe5 hente et subsett av dataene, selv om man bruker ",(0,i.kt)("inlineCode",{parentName:"p"},"SELECT *"),", da tabellen er partisjonert p\xe5 feltet ",(0,i.kt)("inlineCode",{parentName:"p"},"from"),". Filteret i ",(0,i.kt)("inlineCode",{parentName:"p"},"WHERE")," delen av sp\xf8rringen gj\xf8r her at vi bare henter rader for innev\xe6rende d\xf8gn. At vi her tar i bruk et filter p\xe5 den partisjonerte kolonnen gj\xf8r at mengden data som m\xe5 hentes g\xe5r fra ~600GB til ~800MB."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n  *\nFROM\n  `saga-trafikkdata-prod-pz8l.internal.timetrafikk`\nWHERE\n  `from` > TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY)\n")),(0,i.kt)("h2",{id:"gruppering-og-aggregering"},"Gruppering og aggregering"),(0,i.kt)("p",null,"Ved \xe5 begnytte seg av n\xf8kkelordene ",(0,i.kt)("inlineCode",{parentName:"p"},"GROUP BY")," kan radene i utvalget grupperes p\xe5 gitte kolonner. Slik kan man enkelt gjennomf\xf8re aggregeringer over flere rader, ved \xe5 dra nytte av ",(0,i.kt)("a",{parentName:"p",href:"https://cloud.google.com/bigquery/docs/reference/standard-sql/aggregate_analytic_functions"},"BigQuery sine aggregat-funksjoner"),"."),(0,i.kt)("p",null,"Eksempelet under viser hvordan man ved \xe5 gruppere m\xe5lestasjoner og deres m\xe5linger fra 1. januar 22 kan regne ut gjennomsnittlig lufttemperatur for denne dagen med funksjonen ",(0,i.kt)("inlineCode",{parentName:"p"},"AVG"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT\n  navn,\n  DATE(md.maaletidspunkt, "Europe/Oslo") dato,\n  ROUND(AVG(lufttemperaturCelsius), 1) gjennomsnittLufttemperaturCelsius,\nFROM\n    `saga-vegvar-prod-znny.standardized.maaledata` md\nJOIN\n  `saga-vegvar-prod-znny.standardized.maalestasjoner` ms\n  ON ms.id = md.maalestasjonId\n  AND ms.versjon = md.maalestasjonVersjon\nWHERE\n  DATE(md.maaletidspunkt, "Europe/Oslo") = "2022-01-01"\nGROUP BY\n  navn, dato\n')),(0,i.kt)("h2",{id:"repeterende-rader"},"Repeterende rader"),(0,i.kt)("p",null,'Bigquery st\xf8tter at felter kan v\xe6re repeterende innad i en rad. Denne type data kan man sp\xf8rre ut ved \xe5 "krysse" radene fra den opprinnelige tabellen mot resultatet av operasjonen ',(0,i.kt)("inlineCode",{parentName:"p"},"UNNEST()"),"."),(0,i.kt)("p",null,"Eksempelet under viser hvordan den opprinnelige radens ",(0,i.kt)("inlineCode",{parentName:"p"},"trpId")," og ",(0,i.kt)("inlineCode",{parentName:"p"},"dato")," blir krysset med hver oppf\xf8ring i det repeterende feltet ",(0,i.kt)("inlineCode",{parentName:"p"},"byLane"),", og man ender med \xe5 f\xe5 vist trafikk per felt per time for det valgte trafikktellepunktet den gitte dagen.."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT\n  trpId,\n  DATETIME(`from`, "Europe/Oslo") AS dato,\n  lanes.lane.laneNumber as felt,\n  lanes.total.volumeNumbers.volume as feltVolum\nFROM\n  `saga-trafikkdata-prod-pz8l.standardized.timetrafikk` timetrafikk,\n  UNNEST(byLane) lanes\nWHERE\n  DATE(`from`, "Europe/Oslo") = "2021-09-15"\n  AND trpId = "16219V72812"\nORDER BY\n  `from`, felt\n')),(0,i.kt)("h2",{id:"testdata-for-utforming-av-sp\xf8rringer"},"Testdata for utforming av sp\xf8rringer"),(0,i.kt)("p",null,"Om man \xf8nsker \xe5 eksperimentere med funksjonalitet i BigQuery eller forst\xe5 hvordan noen av de tilgjengelige SQL-operasjonene fungerer, kan det v\xe6re kjekt \xe5 generere test data som del av selve sp\xf8rringen. Dette kan f.eks. gj\xf8res med en kombinasjon av ",(0,i.kt)("inlineCode",{parentName:"p"},"SELECT")," og ",(0,i.kt)("inlineCode",{parentName:"p"},"UNNEST()")," av en liste med ",(0,i.kt)("inlineCode",{parentName:"p"},"STRUCT"),"s."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT\n  TIMESTAMP_TRUNC(instant, HOUR) as hour,\n  MAX(value) as maxValue\nFROM\n  UNNEST([\n    STRUCT(41 as value, TIMESTAMP("2022-04-08 10:51:42 UTC") as instant),\n    (43, TIMESTAMP("2022-04-08 11:52:31 UTC")),\n    (42, TIMESTAMP("2022-04-08 11:55:42 UTC")),\n    (43, TIMESTAMP("2022-04-08 12:51:22 UTC")),\n    (44, TIMESTAMP("2022-04-08 12:55:52 UTC"))])\nGROUP BY\n  hour\n')),(0,i.kt)("p",null,"En annen variant av dette kan v\xe6re \xe5 bruke ",(0,i.kt)("inlineCode",{parentName:"p"},"UNION ALL"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT\n  TIMESTAMP_TRUNC(instant, HOUR) as hour,\n  MAX(value) as maxValue\nFROM\n  (SELECT 41 as value, TIMESTAMP("2022-04-08 10:51:42 UTC") as instant\n   UNION ALL SELECT 43, TIMESTAMP("2022-04-08 11:52:31 UTC")\n   UNION ALL SELECT 42, TIMESTAMP("2022-04-08 11:55:42 UTC")\n   UNION ALL SELECT 43, TIMESTAMP("2022-04-08 12:51:22 UTC")\n   UNION ALL SELECT 44, TIMESTAMP("2022-04-08 12:55:52 UTC"))\nGROUP BY\n  hour\n')),(0,i.kt)("h2",{id:"deduplisering"},"Deduplisering"),(0,i.kt)("p",null,"Ofte inneholder datasett og deres tabeller duplikate rader som det er \xf8nskelig \xe5 bli kvitt f\xf8r videre analyser gjennomf\xf8res, for \xe5 unng\xe5 feil i beregninger eller forenkle sp\xf8rringene som m\xe5 gj\xf8res. Ett slikt eksempel der dette kan v\xe6re nyttig er i datasettet M\xe5lestasjoner, der m\xe5lestasjoner kan opptre flere ganger i forskjellig versjon, f.eks. om de har endret navn. BigQuery har flere m\xe5ter \xe5 fjerne disse duplikate radene p\xe5."),(0,i.kt)("p",null,"Eksempelet under viser hvordan man kan bruke n\xf8kkelordene ",(0,i.kt)("inlineCode",{parentName:"p"},"PARTITION BY")," til \xe5 partisjonere utvalget rader p\xe5 feltet ",(0,i.kt)("inlineCode",{parentName:"p"},"id"),", og sortere innad i hver av disse partisjonene basert p\xe5 ",(0,i.kt)("inlineCode",{parentName:"p"},"versjon"),", vha. n\xf8kkelordene ",(0,i.kt)("inlineCode",{parentName:"p"},"ORDER BY"),". Slik vil de nyeste versjonene av m\xe5lestasjonene komme f\xf8rst i partisjonen. Hver av radene i partisjonen blir s\xe5 tildelt et radnummer med funksjonen ",(0,i.kt)("inlineCode",{parentName:"p"},"ROW_NUMBER()")," f\xf8r en ytre ",(0,i.kt)("inlineCode",{parentName:"p"},"SELECT")," igjen bare tar vare p\xe5 radene med ",(0,i.kt)("inlineCode",{parentName:"p"},"rowNumber = 1"),", for \xe5 sikre at man ender med \xe9n rad per m\xe5lestasjon. Dette vil v\xe6re den utgaven av m\xe5lestasjonen som har det h\xf8yeste versjonsnummeret."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n  * EXCEPT (rowNumber)\nFROM\n  (SELECT\n     id,\n     versjon,\n     navn,\n     ROW_NUMBER() OVER (\n        PARTITION BY id\n        ORDER BY CAST(versjon AS INT) DESC) rowNumber\n    FROM `saga-vegvar-prod-znny.standardized.maalestasjoner`)\nWHERE\n  rowNumber = 1\n")))}m.isMDXComponent=!0}}]);