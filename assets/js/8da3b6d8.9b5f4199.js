"use strict";(self.webpackChunksaga_docs=self.webpackChunksaga_docs||[]).push([[929],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return g}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=p(n),g=a,d=m["".concat(l,".").concat(g)]||m[g]||c[g]||o;return n?r.createElement(d,i(i({ref:t},u),{},{components:n})):r.createElement(d,i({ref:t},u))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1230:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return g},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return c}});var r=n(7462),a=n(3366),o=(n(7294),n(3905)),i=["components"],s={},l="GitHub Actions & Workflows",p={unversionedId:"utvikling-paa-saga/github-actions",id:"utvikling-paa-saga/github-actions",title:"GitHub Actions & Workflows",description:"Dersom man benytter GitHub for kildekontroll kan man ogs\xe5 bruke GitHub Actions for automatiserte oppgaver, som release og deploy, kj\xf8ring av tester og linting.",source:"@site/docs/03-utvikling-paa-saga/06-github-actions.md",sourceDirName:"03-utvikling-paa-saga",slug:"/utvikling-paa-saga/github-actions",permalink:"/docs-public/utvikling-paa-saga/github-actions",draft:!1,editUrl:"https://github.com/svvsaga/docs-public/edit/main/docs/03-utvikling-paa-saga/06-github-actions.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Terraform",permalink:"/docs-public/utvikling-paa-saga/terraform"},next:{title:"Sensitive data",permalink:"/docs-public/utvikling-paa-saga/sensitive-data"}},u={},c=[{value:"<code>projects.config.json</code>",id:"projectsconfigjson",level:2},{value:"<code>projects.config.json</code> i roten av repoet:",id:"projectsconfigjson-i-roten-av-repoet",level:3},{value:"<code>projects.config.json</code> inne i mappen til et prosjekt:",id:"projectsconfigjson-inne-i-mappen-til-et-prosjekt",level:3},{value:"Eksempel: Release og deploy av Terraform",id:"eksempel-release-og-deploy-av-terraform",level:2},{value:"Deploy",id:"deploy",level:3}],m={toc:c};function g(e){var t=e.components,s=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},m,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"github-actions--workflows"},"GitHub Actions & Workflows"),(0,o.kt)("p",null,"Dersom man benytter GitHub for kildekontroll kan man ogs\xe5 bruke ",(0,o.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions"},"GitHub Actions")," for automatiserte oppgaver, som release og deploy, kj\xf8ring av tester og linting."),(0,o.kt)("p",null,"For \xe5 f\xe5 en oversikt over konsepter som Workflows, Events, Jobs og Actions, ",(0,o.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/learn-github-actions/understanding-github-actions"},"se dokumentasjonen til GitHub"),"."),(0,o.kt)("p",null,"Vi har laget et repo ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/svvsaga/github-actions-public"},"github-actions-public")," med mange nyttige workflows og actions, f.eks.:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Workflows:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/svvsaga/github-actions-public/blob/main/.github/workflows/publish-terraform-plans.yml"},"Publisere en Terraform-plan til alle 3 milj\xf8er")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/svvsaga/github-actions-public/blob/main/.github/workflows/apply-terraform-plan.yml"},"Deploye en publisert Terraform-plan")))),(0,o.kt)("li",{parentName:"ul"},"Actions:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/svvsaga/github-actions-public/blob/main/setup-gcloud/action.yml"},"Setup Google Cloud SDK med autentisering")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/svvsaga/github-actions-public/tree/main/show-terraform-plan-on-pr"},"Vise endringer i Terraform ved Pull Request"))))),(0,o.kt)("p",null,"Det kommer stadig flere tilskudd, og hvis det er noe dere savner er det bare \xe5 ta kontakt p\xe5 ",(0,o.kt)("a",{parentName:"p",href:"https://vegvesen.slack.com/archives/C03LGD7TM5Z"},"#saga-support p\xe5 Slack"),"."),(0,o.kt)("h2",{id:"projectsconfigjson"},(0,o.kt)("inlineCode",{parentName:"h2"},"projects.config.json")),(0,o.kt)("p",null,"Mange av v\xe5re GitHub Actions og Workflows forutsetter at man har lagt inn en ",(0,o.kt)("inlineCode",{parentName:"p"},"projects.config.json"),"-fil for prosjektet man jobber i, samt \xe9n ",(0,o.kt)("inlineCode",{parentName:"p"},"projects.config.json"),"-fil i roten av repoet, som beskriver teamets felles-prosjekt. Disse filene vil se ut som noe slikt:"),(0,o.kt)("h3",{id:"projectsconfigjson-i-roten-av-repoet"},(0,o.kt)("inlineCode",{parentName:"h3"},"projects.config.json")," i roten av repoet:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "projectNumbers": {\n    "SHARED": 123456789\n  },\n  "SHARED": "saga-myteam-shared"\n}\n')),(0,o.kt)("h3",{id:"projectsconfigjson-inne-i-mappen-til-et-prosjekt"},(0,o.kt)("inlineCode",{parentName:"h3"},"projects.config.json")," inne i mappen til et prosjekt:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "projectNumbers": {\n    "STM": 123456789,\n    "ATM": 234567834,\n    "PROD": 3456457645\n  },\n  "STM": "saga-my-project-stm",\n  "ATM": "saga-my-project-atm",\n  "PROD": "saga-my-project-prod"\n}\n')),(0,o.kt)("p",null,"Disse benyttes blant annet til \xe5 gj\xf8re autentisering med GCP, via ",(0,o.kt)("a",{parentName:"p",href:"https://cloud.google.com/iam/docs/workload-identity-federation"},"Workload Identity Federation"),", som er et sikrere alternativ til langtlevende Service Account Keys."),(0,o.kt)("p",null,"For \xe5 generere disse filene automatisk, s\xf8rg for at du er inlogget i ",(0,o.kt)("inlineCode",{parentName:"p"},"gcloud"),", og deretter kj\xf8r:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"npm install -D svvsaga/node-modules-public\nnpx generate-gcp-project-config-interactive\n")),(0,o.kt)("p",null,"Du vil bli bedt om \xe5 velge ditt team, og ditt prosjekt. Prosjektet m\xe5 matche en mappe som allerede finnes."),(0,o.kt)("h2",{id:"eksempel-release-og-deploy-av-terraform"},"Eksempel: Release og deploy av Terraform"),(0,o.kt)("p",null,"Gitt at man \xf8nsker \xe5 deploye en ny versjon av et system hver gang det gj\xf8res en kodeendring, kan man sette opp en workflow som trigger p\xe5 endringer i hoved-branchen:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"name: Publish my app on changes\n\non:\n  # Gj\xf8r at workflow trigger p\xe5 push til main hvis det er endringer i my-app/\n  push:\n    branches:\n      - main\n    paths:\n      - my-app/**\n  # Gj\xf8r det mulig \xe5 kalle workflow manuelt\n  workflow_dispatch:\n\nenv:\n  # Brukes av create-release for \xe5 kalle GitHub API\n  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n  # Brukes for \xe5 gi navn til releasen\n  APP_ID: my-app\n  # Brukes for \xe5 sette nummer p\xe5 releasen\n  RELEASE_VERSION: ${{ github.run_number }}\n\njobs:\n  # F\xf8rst opprettes en release\n  create_release:\n    name: Terraform plan\n    runs-on: ubuntu-latest\n    # Denne jobben er definert som et sett av steg (i dette tilfellet bare ett steg)\n    steps:\n      - name: Create Release\n        id: create_release\n        uses: actions/create-release@v1\n        with:\n          tag_name: ${{ env.APP_ID }}-TF-v${{ env.RELEASE_VERSION }}\n          release_name: ${{ env.APP_ID }}-TF-v${{ env.RELEASE_VERSION }}\n    outputs:\n      # Gj\xf8r det mulig \xe5 referere til den opprettede releasen i f\xf8lgende jobb\n      release_id: ${{ steps.create_release.outputs.id }}\n\n  # Deretter kj\xf8rer en ferdig workflow som publiserer 3 ulike Terraform-planer, en for hvert milj\xf8 (STM, ATM, PROD)\n  publish_plans:\n    name: Publish Terraform plans\n    # N\xe5r 'needs' er satt, vil ikke denne jobben kj\xf8re for forrige jobb er ferdig, slik at outputs er tilgjengelige\n    needs: create_release\n    # Denne jobben har ikke egne steg, men refererer til en spesifikk versjon av en ferdig workflow p\xe5 github-actions-public repo\n    uses: svvsaga/github-actions-public/.github/workflows/publish-terraform-plans.yml@v9.0.0\n    with:\n      app_root: my-app\n      release_id: ${{ needs.create_release.outputs.release_id }}\n    secrets:\n      # En installert GitHub App brukes for \xe5 autentisere mot GitHub for operasjoner som g\xe5r utover det den innebygde token f\xe5r lov \xe5 gj\xf8re\n      github_app_private_key: ${{ secrets.ACTIONS_APP_PEM }}\n      github_app_id: ${{ secrets.ACTIONS_APP_ID }}\n      # Man kan sende med ekstra Terraform-variabler\n      terraform_vars: |-\n        slack_auth_token = \"${{ secrets.SLACK_AUTH_TOKEN }}\"\n")),(0,o.kt)("p",null,"Med denne workflowen vil hver kodeendring f\xf8re til en ny release. Man kan ogs\xe5 opprette nye releases manuelt ved \xe5 g\xe5 til Actions-fanen og kj\xf8re workflowen manuelt:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Manuell kj\xf8ring av workflow",src:n(5496).Z,width:"955",height:"539"})),(0,o.kt)("p",null,"I dette tilfellet er det ogs\xe5 satt opp et eget input-felt for \xe5 overstyre hvilken commit eller branch man vil publisere, men det er ikke n\xf8dvendig."),(0,o.kt)("h3",{id:"deploy"},"Deploy"),(0,o.kt)("p",null,"N\xe5r workflowen for \xe5 lage release er gr\xf8nn, kan man fortsette med selve deployen. En typisk deploy-workflow kan se slik ut:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"name: My app - Terraform deploy\non:\n  workflow_dispatch:\n    inputs:\n      # Man m\xe5 manuelt sjekke hvilken release man har publisert sist\n      ref:\n        description: Which release to deploy, e.g. \"my-app-TF-v13\"\n        required: true\n        default: my-app-TF-v\n        type: string\n      # Her benyttes en 'choice' type for \xe5 gi en dropdown i GUI\n      environment:\n        description: Which environment to deploy to (STM, ATM or PROD). Defaults to STM.\n        required: true\n        default: STM\n        type: choice\n        options:\n          - STM\n          - ATM\n          - PROD\n      # Workflowene vil vanligvis avbryte dersom det finnes forskjeller i state mellom n\xe5r planen ble laget og n\xe5r den skal deployes. Man kan overstyre dette ved \xe5 sette skip_diff=true, f.eks. hvis man m\xe5 re-kj\xf8re en deploy som kj\xf8rte halvveis vellykket\n      skip_diff:\n        required: false\n        default: 'false'\n        description: Set to 'true' to apply Terraform plan without checking if state has changed since plan was created.\n        # Vil gi en checkbox i GUI\n        type: boolean\n\njobs:\n  deploy:\n    uses: svvsaga/github-actions-public/.github/workflows/apply-terraform-plan.yml@v9.0.1\n    with:\n      ref: ${{ inputs.ref }}\n      environment: ${{ inputs.environment }}\n      skip_diff: ${{ inputs.skip_diff }}\n      app_root: my-app\n      application_name: My App\n    secrets:\n      github_app_private_key: ${{ secrets.ACTIONS_APP_PEM }}\n      github_app_id: ${{ secrets.ACTIONS_APP_ID }}\n")),(0,o.kt)("p",null,"Kj\xf8ringen av denne workflowen kan gj\xf8res p\xe5 samme Actions-fane i GitHub:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Deploy workflow",src:n(7723).Z,width:"1924",height:"1218"})),(0,o.kt)("p",null,"Det er ogs\xe5 mulig \xe5 benytte verkt\xf8y som ",(0,o.kt)("a",{parentName:"p",href:"https://githubdeploy.z1.web.core.windows.net/"},"GitHub Deploy Center")," for \xe5 gj\xf8re deployment enklere:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"GitHub Deploy Center",src:n(7734).Z,width:"2488",height:"1514"})),(0,o.kt)("p",null,"Her kan du sette opp deployment per milj\xf8 av flere ulike applikasjoner, samt se hvilke versjoner som er deployet i hvilke milj\xf8. Les mer p\xe5 ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/geirsagberg/github-deploy-center"},"https://github.com/geirsagberg/github-deploy-center"),", eller ta kontakt med ",(0,o.kt)("a",{parentName:"p",href:"https://vegvesen.slack.com/archives/C03LGD7TM5Z"},"#saga-support p\xe5 Slack")," for mer informasjon."))}g.isMDXComponent=!0},7723:function(e,t,n){t.Z=n.p+"assets/images/deploy-workflow-1b169d1757fee3259200d0b099a1ff9b.png"},7734:function(e,t,n){t.Z=n.p+"assets/images/github-deploy-center-86a6ca84debce226d83751a06bf150a7.png"},5496:function(e,t,n){t.Z=n.p+"assets/images/workflow-dispatch-f30b1ae8d69e795f584d260aa814f92a.png"}}]);